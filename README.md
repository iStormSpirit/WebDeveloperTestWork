# Бэкенд для симулятора биржи

Предлагается разработать простой симулятор биржи с клиент-серверной архитектурой.

Биржа это такой "сервис" куда можно отправить заявку (ордер) на покупку или продажу какого либо актива. Получив заявку
биржа, применяя некую торговую логику, ищет встречную заявку для заключения сделки. Заявка в итоге может быть исполнена,
отклонена или же ее можно отменить самому. При выставлении заявки можно ориентироваться на текущие цены данного актива (
котировки), для более вероятного исполнения заявки.

Взаимодействие с биржей происходит через торговый терминал, который является клиентом в данной архитектуре, а сама
биржа - это сервер.

## Биржа

Биржа (сервер) поддерживает подключение по протоколу `websocket` нескольких клиентов одновременно, дает им возможность:

* получать информацию о всех своих заявках
* получать текущие котировки
* выставлять заявки
* отменять активные заявки

## Локальный запуск проекта

Скачать архив (предварительно должен быть установлен docker и docker-compose).

```
git clone git@github.com:iStormSpirit/WebDeveloperTestWork.git
```

Перейти в папку и собрать контейнер

```
cd WebDeveloperTestWork/server/server && docker-compose up 
```

Во втором окне терминала сделать миграцию

```
docker-compose exec web alembic upgrade head
```

Если необходимо, то запустить тесты

```
docker-compose exec web pytest
```

Перейти в браузер по адресу http://127.0.0.1:8000/

## API

### Структура сообщений

Все сообщения имеют общий `JSON` формат:

    {
        "messageType": <integer>,
        "message": <object>
    }

В зависимости от типа сообщения (`messageType`) само сообщение (`message`) должно иметь конкретный формат, например:

**SubscribeMarketData** `messageType=1`

    | Field          | Type     | Comment                                                            |
    |----------------|----------|--------------------------------------------------------------------|
    | **instrument** | integer  | Идентификатор инструмента на котировки которого запрошена подписка |

Пример:

        {"instrument": 12}

В случае успешной подписки, сервер отвечает сообщением **SuccessInfo**, где поле `message` будет содержать идентификатор
подписки:

        {"subscriptionId": <string:UUID>}

И далее при каждом изменении котировок, сервер будет присылать сообщение **MarketDataUpdate**.

В случае какой-либо ошибки, сервер отвечает сообщением **ErrorInfo**, где поле `message` будет содержать описание
причины ошибки:

        {"reason": <string>}

Чтобы отменить подписку, нужно отправить сообщение **UnsubscribeMarketData**.

### Примеры сообщений

#### Подписка на инструмент

Запрос:

```
{
    "messageType": 1,
    "message": {"instrument": 1}
}
```

Ответ:

```
{
    "messageType": 1,
    "message": {"subscriptionId": "8e565f01-33eb-44c5-a827-c870115cccc8"}
}
```

#### Отписка от инструмента

Запрос:

```
{
    "messageType": 2,
    "message": {"subscriptionId": "8e565f01-33eb-44c5-a827-c870115cccc8"}
}
```

Ответ:

```
{
    "messageType": 1,
    "message": {"subscriptionId": "8e565f01-33eb-44c5-a827-c870115cccc8"}
}
```

#### Размещение заявки

Запрос:

```
{
    "messageType": 3,
    "message": {"instrument": 2, "side": 1, "amount": 5, "price": 100}
}
```

Ответ:

```
{
    "messageType": 3,
    "message": {"orderId": "8e565f01-33eb-44c5-a827-c870115cccc8", "orderStatus": "active"}
}
```

#### Сообщение с результатом обработки заявки

Ответ:

```
{
    "messageType": 3,
    "message": {"orderId": "8e565f01-33eb-44c5-a827-c870115cccc8", "orderStatus": "filled"}
}
```

#### Сообщение с результатом автоотмены заявки

Ответ:

```
{
    "messageType": 3,
    "message": {"orderId": "8e565f01-33eb-44c5-a827-c870115cccc8", "orderStatus": "rejected"}
}
```

#### Отмена заявки

Запрос:

```
{
    "messageType": 4,
    "message": {"orderId": "8e565f01-33eb-44c5-a827-c870115cccc8"}
}
```

Ответ:

```
{
    "messageType": 3,
    "message": {"orderId": "8e565f01-33eb-44c5-a827-c870115cccc8", "orderStatus": "cancelled"}
}
```

#### Запрос всех своих заявок

Запрос:

```
{
    "messageType": 5,
    "message": {}
}
```

Ответ:

```
{
    "messageType": 5,
    "message": {
                "orders": 
                         [        
                              {    
                                   "creationTime": "2023-01-01T00:00:00.000000",
                                   "changeTime": "2023-01-01T00:00:00.000000",
                                   "status": "rejected",  "side": "buy",
                                   "price": 50, "amount": 5,
                                   "instrument": "EUR/RUB",
                                   "uuid": "8e565f01-33eb-44c5-a827-c870115cccc8"
                              },
                              {    
                                   "creationTime": "2023-01-01T00:00:00.000000",
                                   "changeTime": "2023-01-01T00:00:00.000000",
                                   "status": "active", "side": "sell",
                                   "price": 50, "amount": 5,
                                   "instrument": "EUR/RUB",
                                   "uuid": "8e565f01-33eb-44c5-a827-c870115cccc8"
                              }
                         ]
               }
}
```

#### Сообщение об изменении котировок

Ответ:

```
{
    "messageType": 4,
    "message": {    
                "subscriptionId": "8e565f01-33eb-44c5-a827-c870115cccc8", "instrument": "USD/RUB",
                "quotes": 
                         [    
                              {    
                                   "bid": 32.6492474374773, "offer": 32.702687400399606,
                                   "minAmount": 30.615497067132219,
                                   "maxAmount": 36.660783514879736,
                                   "timestamp": "2023-01-01T00:00:00.000000"
                              },
                              {
                                   "bid": 35.13073866239448, "offer": 37.42933397198178,
                                   "minAmount": 34.009541545391483,
                                   "maxAmount": 38.972840028018506,
                                   "timestamp": "2023-01-01T00:00:00.000000"
                              }
                         ]
               }
}
```

#### Сообщение об ошибке

Ответ:

```
{
    "messageType": 2,
    "message": {"reason": "The message is not a valid JSON"}
}
```
